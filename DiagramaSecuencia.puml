@startuml DiagramaSecuencia
skinparam shadowing false
skinparam sequence {
  ArrowColor #2C5F75
  ActorBorderColor #D68C45
  ActorBackgroundColor #FFE5D9
  ParticipantBorderColor #4A90A4
  ParticipantBackgroundColor #E8F4F8
  LifeLineBorderColor #95A5A6
  FontColor #2C3E50
}

title Diagrama de Secuencia - Proceso de Venta de Boletos (Arquitectura MVC)

actor "Vendedor" as V
participant "Vista:\nInterfaz\nVentas" as Vista
participant "Controlador:\nVentas" as Ctrl
database "Base de\nDatos" as BD

== Selección de Película ==
V -> Vista: Iniciar venta
activate Vista
Vista -> Ctrl: Solicitar catálogo de películas
activate Ctrl
Ctrl -> BD: Obtener todas las películas en cartelera
activate BD
BD --> Ctrl: Lista de películas disponibles
deactivate BD
Ctrl --> Vista: Películas formateadas
deactivate Ctrl
Vista --> V: Mostrar catálogo

V -> Vista: Seleccionar película
Vista -> Ctrl: Obtener detalles (id_película)
activate Ctrl
Ctrl -> BD: Buscar película por ID y obtener información completa
activate BD
BD --> Ctrl: Detalles de la película
deactivate BD
Ctrl --> Vista: Detalles confirmados
deactivate Ctrl
Vista --> V: Mostrar detalles

== Selección de Horario ==
Vista -> Ctrl: Solicitar horarios (id_película)
activate Ctrl
Ctrl -> BD: Obtener horarios para la película desde hoy en adelante
activate BD
BD --> Ctrl: Horarios disponibles
deactivate BD
Ctrl --> Vista: Horarios formateados
deactivate Ctrl
Vista --> V: Mostrar horarios disponibles

V -> Vista: Seleccionar horario
Vista -> Ctrl: Verificar capacidad (id_horario)
activate Ctrl
Ctrl -> BD: Contar asientos disponibles para el horario
activate BD
BD --> Ctrl: Cantidad de asientos libres
deactivate BD
Ctrl --> Vista: Horario confirmado
deactivate Ctrl
Vista --> V: Mostrar confirmación

== Selección de Asiento ==
Vista -> Ctrl: Solicitar mapa de asientos (id_horario)
activate Ctrl
Ctrl -> BD: Obtener estado de todos los asientos del horario
activate BD
BD --> Ctrl: Mapa completo de asientos
deactivate BD
Ctrl --> Vista: Mapa estructurado
deactivate Ctrl
Vista --> V: Mostrar mapa visual

V -> Vista: Seleccionar asiento (fila, columna)
Vista -> Ctrl: Reservar asiento temporalmente
activate Ctrl
Ctrl -> BD: Bloquear asiento seleccionado
activate BD
BD --> Ctrl: Asiento bloqueado exitosamente
deactivate BD
Ctrl --> Vista: Confirmación de reserva
deactivate Ctrl
Vista --> V: Mostrar asiento reservado

== Proceso de Pago ==
V -> Vista: Ingresar datos del cliente
Vista -> Ctrl: Registrar datos cliente
activate Ctrl
Ctrl -> BD: Guardar nuevo cliente con nombre, email y teléfono
activate BD
BD --> Ctrl: Cliente registrado con ID
deactivate BD
Ctrl --> Vista: Cliente registrado
deactivate Ctrl
Vista --> V: Confirmación registro

V -> Vista: Seleccionar método de pago
Vista -> Ctrl: Calcular total (id_horario, id_asiento)
activate Ctrl
Ctrl -> BD: Obtener precio del horario
activate BD
BD --> Ctrl: Precio base del boleto
deactivate BD

alt Aplica descuento
    V -> Vista: Aplicar descuento (código)
    Vista -> Ctrl: Validar descuento
    Ctrl -> BD: Buscar descuento por código y verificar si está activo
    activate BD
    BD --> Ctrl: Porcentaje de descuento
    deactivate BD
    Ctrl -> Ctrl: Aplicar descuento al precio
end

Ctrl --> Vista: Monto final
deactivate Ctrl
Vista --> V: Mostrar resumen y total

V -> Vista: Confirmar pago
Vista -> Ctrl: Procesar transacción
activate Ctrl
Ctrl -> BD: Registrar venta con cliente, asiento, monto y método de pago
activate BD
BD --> Ctrl: Venta registrada con ID
deactivate BD

alt Pago exitoso
    Ctrl -> BD: Marcar asiento como ocupado y asociar a la venta
    activate BD
    BD --> Ctrl: Asiento confirmado
    deactivate BD
    
    Ctrl -> BD: Crear boleto con código QR y fecha de emisión
    activate BD
    BD --> Ctrl: Boleto generado
    deactivate BD
    Ctrl --> Vista: Boleto listo para imprimir
    deactivate Ctrl
    Vista --> V: Imprimir boleto
    V -> V: Entregar boleto al cliente
    
else Pago fallido
    Ctrl -> BD: Liberar asiento y marcar como disponible
    activate BD
    BD --> Ctrl: Asiento disponible nuevamente
    deactivate BD
    Ctrl --> Vista: Mensaje de error en pago
    deactivate Ctrl
    Vista --> V: Mostrar error y permitir reintentar
end

deactivate Vista

@enduml
